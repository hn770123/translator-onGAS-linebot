# スプレッドシート設定ガイド

このドキュメントでは、LINE翻訳Botのデータ保存用Googleスプレッドシートの設定方法を説明します。

## 概要

Googleスプレッドシートは、以下の目的で使用されます：

- 翻訳ログの長期保存
- プロンプトと応答の全件記録
- パフォーマンスメトリクスの収集
- テスト・デバッグ・分析

## スプレッドシートの作成

### 1. 新しいスプレッドシートを作成

1. [Google Sheets](https://sheets.google.com/)にアクセス
2. 「空白」をクリックして新しいスプレッドシートを作成
3. 名前を「LINE翻訳Bot ログ」など適切な名前に変更

### 2. スプレッドシートIDを取得

URLから**スプレッドシートID**を取得します：

```
https://docs.google.com/spreadsheets/d/SPREADSHEET_ID/edit
                                          ↑この部分
```

このIDを環境変数 `SPREADSHEET_ID` に設定します（[ENV.md](ENV.md)参照）。

## シートの構造

### 翻訳ログシート

Botが動作すると、自動的に「翻訳ログ」シートが作成され、以下の列が設定されます：

| 列名 | 説明 | データ型 | 例 |
|------|------|----------|-----|
| タイムスタンプ | 翻訳処理の日時 | DateTime | 2025-01-15 10:30:45 |
| ユーザーID | LINEユーザーID | String | U1234567890abcdef... |
| 言語 | 検出された言語 | String | ja, en, pl |
| 元メッセージ | ユーザーの入力 | String | 昨日映画を見た |
| 翻訳結果 | Botの翻訳結果 | String | I watched a movie yesterday. |
| 使用プロンプト | Gemini APIに送信したプロンプト | String | あなたは優秀な翻訳... |
| 履歴取得時間(ms) | 履歴取得にかかった時間 | Number | 5 |
| 翻訳時間(ms) | 翻訳処理にかかった時間 | Number | 1250 |
| 合計応答時間(ms) | 総応答時間 | Number | 1850 |
| 履歴件数 | 参照した履歴の件数 | Number | 2 |

### 自動作成について

**重要**: 「翻訳ログ」シートは、Botが初めてメッセージを受信した際に自動的に作成されます。手動で作成する必要はありません。

## オプション：追加シートの作成

分析やテストを効率化するため、以下のシートを追加で作成することを推奨します。

### 1. テストケースシート

テストケースを管理するためのシートです。

**シート名**: `テストケース`

| テストID | 入力メッセージ | 期待される翻訳 | 言語 | ステータス | メモ |
|---------|--------------|--------------|------|----------|------|
| TC001 | 昨日映画を見た | I watched a movie yesterday. | ja→en | ✓ | 基本翻訳 |
| TC002 | とても面白かった | It was very interesting. | ja→en | ✓ | 文脈参照（映画） |

### 2. エラー分析シート

エラーが発生した際の記録用シートです。

**シート名**: `エラーログ`

| タイムスタンプ | エラー種別 | エラーメッセージ | ユーザーID | 入力メッセージ | 対応状況 |
|-------------|----------|---------------|----------|-------------|---------|
| 2025-01-15 10:45:00 | Gemini API Error | Rate limit exceeded | U1234... | Hello | 修正済み |

### 3. 統計ダッシュボードシート

**シート名**: `統計`

翻訳ログから集計するための数式を配置します：

```
総翻訳数: =COUNTA('翻訳ログ'!A:A)-1
平均応答時間: =AVERAGE('翻訳ログ'!I:I)
最頻言語: =MODE('翻訳ログ'!C:C)
```

## データのフィルタリングと分析

### ユーザーIDでフィルタリング

特定のユーザーの翻訳履歴を確認する方法：

1. 「翻訳ログ」シートを開く
2. データ範囲を選択（A1:J1000など）
3. 「データ」→「フィルタを作成」をクリック
4. 「ユーザーID」列のフィルタアイコンをクリック
5. 対象のユーザーIDを選択

### パフォーマンス分析

応答時間が遅い翻訳を特定する方法：

1. 「翻訳ログ」シートを開く
2. データ範囲を選択
3. 「データ」→「フィルタを作成」をクリック
4. 「合計応答時間(ms)」列のフィルタアイコンをクリック
5. 「条件でフィルタ」→「次より大きい」→「3000」（3秒以上）

### 言語別の使用状況

言語ごとの翻訳回数を集計：

```
=COUNTIF('翻訳ログ'!C:C,"ja")  // 日本語の件数
=COUNTIF('翻訳ログ'!C:C,"en")  // 英語の件数
=COUNTIF('翻訳ログ'!C:C,"pl")  // ポーランド語の件数
```

## プロンプトの確認とデバッグ

翻訳品質を向上させるため、「使用プロンプト」列を確認します：

1. 翻訳が不適切だった行を特定
2. 「使用プロンプト」列で送信したプロンプトを確認
3. プロンプトの改善点を検討
4. `Code.gs`の`buildTranslationPrompt`関数を修正

## データの保持期間

スプレッドシートの行数制限（最大500万セル）に注意してください。

### 推奨される対応策

1. **定期的なアーカイブ**
   - 月次で古いデータを別のスプレッドシートに移動
   - 過去6ヶ月以上のデータはアーカイブ

2. **自動削除スクリプト**（オプション）

以下のコードを`Code.gs`に追加すると、90日以上古いデータを自動削除できます：

```javascript
function cleanupOldData() {
  try {
    const spreadsheetId = PropertiesService.getScriptProperties().getProperty('SPREADSHEET_ID');
    const spreadsheet = SpreadsheetApp.openById(spreadsheetId);
    const sheet = spreadsheet.getSheetByName('翻訳ログ');

    if (!sheet) return;

    const data = sheet.getDataRange().getValues();
    const now = new Date();
    const ninetyDaysAgo = new Date(now.getTime() - (90 * 24 * 60 * 60 * 1000));

    // 古いデータを削除
    for (let i = data.length - 1; i > 0; i--) {
      const timestamp = data[i][0];
      if (timestamp < ninetyDaysAgo) {
        sheet.deleteRow(i + 1);
      }
    }

    Logger.log('Old data cleanup completed');
  } catch (error) {
    Logger.log('Error in cleanupOldData: ' + error.toString());
  }
}
```

トリガーを設定して月次で自動実行：
1. Apps Scriptエディタで「トリガー」をクリック
2. 「トリガーを追加」をクリック
3. 関数: `cleanupOldData`
4. イベントソース: `時間主導型`
5. 時間ベースのトリガー: `月タイマー`

## セキュリティとプライバシー

### 共有設定

スプレッドシートの共有設定を適切に管理してください：

1. デフォルトでは「制限付き」（自分のみアクセス可能）
2. チームで共有する場合は、必要最小限のユーザーのみに権限付与
3. 「リンクを知っている全員が閲覧可」は避ける

### 個人情報の取り扱い

- ユーザーIDは匿名化されたLINE IDです
- メッセージ内容には個人情報が含まれる可能性があります
- GDPR等の規制に準拠する必要がある場合は、データ保持ポリシーを設定してください

## トラブルシューティング

### 「スプレッドシートへの書き込みに失敗する」

1. `SPREADSHEET_ID`が正しく設定されているか確認
2. Apps ScriptアカウントとスプレッドシートのGoogleアカウントが同じか確認
3. スプレッドシートが削除されていないか確認

### 「シートが自動作成されない」

1. 初回メッセージ送信後、スプレッドシートを再読み込み
2. Apps Scriptの実行ログでエラーを確認
3. `saveToSpreadsheetAsync`関数でエラーが発生していないか確認

### 「データが保存されていない」

1. `SPREADSHEET_ID`が設定されているか確認（未設定の場合はスキップされる）
2. Apps Scriptの実行ログを確認
3. Googleスプレッドシートの権限を確認

## 次のステップ

スプレッドシートの設定が完了したら、[DEPLOYMENT.md](DEPLOYMENT.md)を参照してデプロイを行ってください。
