# デプロイ手順書

このドキュメントでは、LINE翻訳BotをGoogle Apps Scriptにデプロイし、LINEと連携させる手順を説明します。

## 前提条件

以下の設定が完了していることを確認してください：

- ✓ Google Apps Scriptプロジェクトを作成
- ✓ `Code.gs`をコピー
- ✓ スクリプトプロパティを設定（[ENV.md](ENV.md)参照）
- ✓ Googleスプレッドシートを作成（[SPREADSHEET_SETUP.md](SPREADSHEET_SETUP.md)参照）

## デプロイ手順

### 1. Google Apps Scriptのデプロイ

#### 1.1 Webアプリとしてデプロイ

1. Google Apps Scriptエディタを開く
2. 右上の「デプロイ」→「新しいデプロイ」をクリック
3. 「種類の選択」で「ウェブアプリ」を選択
4. 以下の設定を行う：
   - **説明**: `LINE翻訳Bot v1.0`（任意）
   - **次のユーザーとして実行**: `自分`
   - **アクセスできるユーザー**: `全員`
5. 「デプロイ」をクリック
6. 権限の承認を求められた場合：
   - 「アクセスを承認」をクリック
   - Googleアカウントを選択
   - 「詳細」→「（プロジェクト名）に移動」をクリック
   - 「許可」をクリック

#### 1.2 ウェブアプリURLの取得

デプロイ完了後、以下のような**ウェブアプリURL**が表示されます：

```
https://script.google.com/macros/s/SCRIPT_ID/exec
```

このURLをコピーしてください。これがLINE Webhook URLになります。

### 2. LINE Messaging APIの設定

#### 2.1 Webhook URLの設定

1. [LINE Developers Console](https://developers.line.biz/console/)にアクセス
2. 作成したチャネルを選択
3. 「Messaging API」タブを開く
4. 「Webhook settings」セクションで「Edit」をクリック
5. 先ほどコピーした**ウェブアプリURL**を貼り付け
6. 「Update」をクリック
7. 「Use webhook」を**有効**にする

#### 2.2 Webhook URLの検証

「Verify」ボタンをクリックして、Webhookが正しく動作することを確認します。

- ✓ **Success**: 正常に動作しています
- ✗ **Failed**: トラブルシューティングセクションを参照

#### 2.3 応答メッセージの設定

LINE公式アカウントの自動応答メッセージを無効にします：

1. 「Messaging API」タブの「LINE Official Account features」セクション
2. 「応答メッセージ」を**無効**にする
3. 「あいさつメッセージ」も**無効**にする（オプション）

### 3. テスト

#### 3.1 友だち追加

1. LINE Developers Consoleの「Messaging API」タブ
2. 「QRコード」をスキャンしてBotを友だち追加

#### 3.2 翻訳テスト

以下のメッセージを送信してテストします：

```
テスト1: こんにちは
期待結果: Hello

テスト2: 今日はいい天気ですね
期待結果: It's nice weather today.

テスト3: Hello
期待結果: こんにちは
```

### 4. デプロイの更新

コードを修正した場合、以下の手順で更新します：

#### 4.1 新しいバージョンをデプロイ

1. Google Apps Scriptエディタで「デプロイ」→「デプロイを管理」をクリック
2. 既存のデプロイの「編集」アイコン（鉛筆マーク）をクリック
3. 右上の「バージョン」で「新バージョン」を選択
4. 「デプロイ」をクリック

**重要**: Webhook URLは変わらないため、LINE側の設定変更は不要です。

#### 4.2 claspを使用する場合（上級者向け）

claspを使ってコマンドラインからデプロイできます：

```bash
# claspのインストール
npm install -g @google/clasp

# ログイン
clasp login

# プロジェクトのクローン
clasp clone SCRIPT_ID

# コードをプッシュ
clasp push

# デプロイ
clasp deploy
```

## デプロイ後の確認事項

### ✓ チェックリスト

- [ ] Webhook URLが正しく設定されている
- [ ] Webhook検証が成功している
- [ ] 応答メッセージが無効になっている
- [ ] Botを友だち追加できる
- [ ] メッセージを送信すると翻訳結果が返ってくる
- [ ] スプレッドシートに翻訳ログが保存されている
- [ ] 2回目以降のメッセージで文脈が考慮されている

### モニタリング

#### Apps Scriptの実行ログ

1. Apps Scriptエディタで「実行数」をクリック
2. 各実行の詳細を確認
3. エラーが発生している場合は「ログを表示」で詳細を確認

#### スプレッドシートの確認

1. 設定したスプレッドシートを開く
2. 「翻訳ログ」シートが自動作成されていることを確認
3. メッセージ送信後、新しい行が追加されることを確認

## トラブルシューティング

### Webhook検証が失敗する

#### 原因1: URLが間違っている
- デプロイ時に生成された正確なURLをコピーしているか確認
- URLの末尾が`/exec`になっているか確認

#### 原因2: デプロイ設定が間違っている
- 「アクセスできるユーザー」が「全員」になっているか確認
- 再度「新しいデプロイ」を作成

#### 原因3: 署名検証エラー
- スクリプトプロパティの`LINE_CHANNEL_SECRET`が正しいか確認
- 余分なスペースや改行が含まれていないか確認

### メッセージを送信しても返信が来ない

#### 原因1: スクリプトプロパティが未設定
- [ENV.md](ENV.md)を参照してすべての環境変数が設定されているか確認
- Apps Scriptエディタで「プロジェクトの設定」→「スクリプトプロパティ」を確認

#### 原因2: LINE_CHANNEL_ACCESS_TOKENが間違っている
- トークンが正しいか確認
- トークンの有効期限が切れていないか確認（LINE Developers Consoleで再発行可能）

#### 原因3: Gemini APIエラー
- Apps Scriptの実行ログでエラーメッセージを確認
- `GEMINI_API_KEY`が正しく設定されているか確認
- Gemini APIの利用上限に達していないか確認

### 翻訳結果がスプレッドシートに保存されない

#### 原因1: SPREADSHEET_IDが未設定
- スクリプトプロパティで`SPREADSHEET_ID`が設定されているか確認
- 未設定の場合、翻訳は機能しますがログは保存されません

#### 原因2: スプレッドシートへのアクセス権限がない
- スプレッドシートとApps Scriptが同じGoogleアカウントで作成されているか確認
- スプレッドシートが削除されていないか確認

#### 原因3: 非同期保存のエラー
- Apps Scriptの実行ログで`saveToSpreadsheetAsync`のエラーを確認
- スプレッドシートのIDが正しいか確認

### 文脈が考慮されない

#### 原因1: 履歴が保存されていない
- 2回目以降のメッセージでも文脈が考慮されない場合、スクリプトプロパティの確認
- Apps Scriptの実行ログで`updateUserHistory`が正常に動作しているか確認

#### 原因2: 履歴が古い
- スクリプトプロパティに保存される履歴は最新2件のみ
- 3件以上前の発言は参照されません

## セキュリティとメンテナンス

### APIキーの定期更新

セキュリティ向上のため、定期的にAPIキーとトークンを更新することを推奨します：

1. LINE Channel Access Tokenを再発行（LINE Developers Console）
2. Gemini API Keyを再生成（Google AI Studio）
3. スクリプトプロパティを更新

### バックアップ

重要なデータは定期的にバックアップしてください：

- **コード**: GitHub等のバージョン管理システムで管理
- **スプレッドシート**: Googleドライブで自動バックアップ（30日間）
- **スクリプトプロパティ**: 手動でエクスポート（コピー＆ペースト）

### パフォーマンスモニタリング

Apps Scriptの実行時間制限（30秒）に注意してください：

- スプレッドシートの「合計応答時間(ms)」列をモニタリング
- 3秒を超える場合は、プロンプトの最適化を検討
- Gemini APIのタイムアウト設定を確認

## 本番環境への移行

テストが完了したら、本番環境に移行します：

1. LINE公式アカウントを作成（フリープラン or 有料プラン）
2. 新しいMessaging APIチャネルを作成
3. 環境変数（Channel Access Token、Channel Secret）を更新
4. 友だちにQRコードを共有

## 次のステップ

デプロイが完了したら、[TESTING.md](TESTING.md)を参照してテストケースを実行してください。
